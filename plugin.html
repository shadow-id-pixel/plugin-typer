<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        :root { 
            --bg-dark: #282828;
            --bg-darker: #1a1a1a;
            --accent: #0078d4;
            --text-light: #eee;
            --border-dark: #444;
            --row-hover: #333;
            --row-active: #094771;
        }
        body { background: var(--bg-dark); color: var(--text-light); font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; font-size: 11px; user-select: none; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header & Scale Box */
        .top-nav { display: flex; gap: 5px; padding: 5px; background: #333; border-bottom: 1px solid var(--border-dark); align-items: center; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 8px; flex: 1; cursor: pointer; font-weight: bold; border-radius: 2px; }
        .btn-main:hover { background: #005a9e; }
        
        .scale-box { display: flex; align-items: center; gap: 5px; background: #444; padding: 4px 8px; border-radius: 2px; border: 1px solid #555; min-width: 110px; }
        .scale-box label { font-size: 11px; color: #ccc; }
        .scale-box input { background: transparent; border: none; color: white; width: 60px; text-align: center; font-weight: bold; outline: none; font-size: 13px; }

        textarea { width: 100%; height: 85px; background: var(--bg-darker); color: #fff; border: none; border-bottom: 1px solid var(--border-dark); padding: 10px; box-sizing: border-box; resize: none; font-family: 'Consolas', monospace; outline: none; font-size: 12px; }
        
        /* List Area (GELAP) */
        .list-box { flex: 1; overflow-y: auto; background: #222; color: #eee; }
        .row { display: flex; align-items: center; border-bottom: 1px solid #333; padding: 8px 12px; cursor: pointer; }
        .row:hover { background: var(--row-hover); }
        .row.active { background: var(--row-active); border-left: 4px solid var(--accent); }
        .num { color: #666; width: 30px; font-size: 10px; }
        .content { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
        .tag { color: #ffca28; margin-right: 6px; font-weight: bold; }

        .footer { background: #1a1a1a; padding: 8px 10px; font-size: 10px; color: #666; border-top: 1px solid var(--border-dark); text-align: center; }
        .footer a { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>
    <div class="top-nav">
        <button class="btn-main" onclick="sendText()">+ Paste & Next</button>
        <div class="scale-box">
            <label>scale:</label>
            <input type="number" id="scaleInput" value="100" min="1" max="1000">
            <span>%</span>
        </div>
        <button style="background:#444; border:none; color:white; padding:8px; cursor:pointer;">âš™</button>
    </div>

    <textarea id="input" oninput="renderLines()" placeholder="Paste script manhwa di sini..."></textarea>

    <div class="list-box" id="list"></div>

    <div class="footer">
        typer for photopea ( inspired by <a href="https://typer.hayasaku.fr" target="_blank">typer.hayasaku.fr</a> )
    </div>

    <script>
        let selectedIndex = -1;
        let linesData = [];

        function renderLines() {
            const val = document.getElementById('input').value;
            linesData = val.split('\n').filter(l => l.trim() !== "");
            const list = document.getElementById('list');
            list.innerHTML = '';

            linesData.forEach((line, i) => {
                let div = document.createElement('div');
                div.className = 'row';
                div.id = 'row-' + i;
                let match = line.match(/^([A-Z()]+):(.*)/);
                let tag = match ? match[1] + ":" : "";
                let txt = match ? match[2] : line;
                div.innerHTML = `<span class="num">${i + 1}</span><span class="content"><span class="tag">${tag}</span>${txt}</span>`;
                div.onclick = () => selectRow(i);
                list.appendChild(div);
            });
        }

        function selectRow(index) {
            selectedIndex = index;
            document.querySelectorAll('.row').forEach(r => r.classList.remove('active'));
            const activeRow = document.getElementById('row-' + index);
            if (activeRow) {
                activeRow.classList.add('active');
                activeRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function sendText() {
            if(selectedIndex === -1 || !linesData[selectedIndex]) return;

            const scaleVal = parseFloat(document.getElementById('scaleInput').value) || 100;
            const fontSize = 25 * (scaleVal / 100);
            
            let line = linesData[selectedIndex];
            let match = line.match(/^([A-Z()]+):(.*)/);
            let cleanText = match ? match[2].trim() : line.trim();

            const ppeaScript = `
                var doc = app.activeDocument;
                
                // Cek Seleksi
                var selBounds;
                try { selBounds = doc.selection.bounds; } catch(e) { selBounds = null; }

                var layer = doc.artLayers.add();
                layer.kind = LayerKind.TEXT;
                var ti = layer.textItem;
                
                ti.contents = "${cleanText.replace(/"/g, '\\"').replace(/\n/g, '\\r')}";
                ti.size = ${fontSize};
                ti.justification = Justification.CENTER;

                if (selBounds) {
                    // Gunakan teknik Point Text yang dipindahkan ke tengah seleksi
                    // Ini jauh lebih aman daripada Paragraph Text di Photopea
                    var centerX = (selBounds[0] + selBounds[2]) / 2;
                    var centerY = (selBounds[1] + selBounds[3]) / 2;
                    
                    ti.position = [centerX, centerY];
                    
                    // Aktifkan wrap jika teks terlalu panjang (opsional)
                    // ti.width = selBounds[2] - selBounds[0]; 
                } else {
                    ti.position = [doc.width / 2, doc.height / 2];
                }
            `;
            window.parent.postMessage(ppeaScript, "*");

            if (selectedIndex < linesData.length - 1) {
                selectRow(selectedIndex + 1);
            }
        }
    </script>
</body>
</html>
