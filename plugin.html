<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        :root { 
            --bg-dark: #282828; --bg-darker: #1a1a1a; --accent: #0078d4;
            --text-light: #eee; --border-dark: #444; --row-hover: #333;
            --row-active: #094771;
            --footer-bg: #f5f5f5; --footer-text: #333;
        }
        body { background: var(--bg-dark); color: var(--text-light); font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; font-size: 11px; user-select: none; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .top-nav { display: flex; gap: 4px; padding: 5px; background: #333; border-bottom: 1px solid var(--border-dark); align-items: center; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 8px; flex: 1; cursor: pointer; font-weight: bold; border-radius: 2px; }
        
        .scale-section { display: flex; align-items: center; background: #444; border-radius: 2px; border: 1px solid #555; height: 28px; padding-right: 5px; }
        .scale-label { font-size: 10px; color: #ccc; padding: 0 8px; }
        .scale-input { background: transparent; border: none; color: white; width: 35px; text-align: center; font-weight: bold; outline: none; }

        textarea#input { width: 100%; height: 80px; background: var(--bg-darker); color: #fff; border: none; border-bottom: 1px solid var(--border-dark); padding: 8px; box-sizing: border-box; resize: none; font-family: 'Consolas', monospace; outline: none; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .list-box { flex: 2; overflow-y: auto; background: #222; border-bottom: 2px solid #444; }
        
        .style-grid { flex: 1.5; overflow-y: auto; background: #333; padding: 5px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; align-content: start; }
        .style-item { display: flex; align-items: center; background: #444; padding: 6px; border-radius: 2px; cursor: pointer; border: 1px solid #555; }
        .style-item.active { background: var(--row-active); border-color: var(--accent); }
        .style-name { flex: 1; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .edit-icon { color: #aaa; cursor: pointer; padding: 2px 5px; font-size: 12px; }

        .row { display: flex; align-items: center; border-bottom: 1px solid #333; padding: 8px 12px; cursor: pointer; }
        .row.active { background: var(--row-active); border-left: 3px solid var(--accent); }
        .tag-pill { background: #FFF3B0; color: #333; padding: 0 4px; border-radius: 2px; margin-right: 6px; font-weight: bold; font-size: 9px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #333; padding: 15px; border-radius: 4px; border: 1px solid #555; max-height: 95%; overflow-y: auto; color: #fff; }
        .modal-input, .modal-select { background: #1a1a1a; color: #fff; border: 1px solid #555; padding: 8px; width: 100%; box-sizing: border-box; margin-top: 5px; border-radius: 2px; margin-bottom: 10px; font-size: 12px; }

        .footer { background: var(--footer-bg); padding: 8px; font-size: 10px; color: var(--footer-text); border-top: 1px solid #ccc; text-align: center; font-weight: 500; }
        .footer a { color: var(--accent); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body onkeydown="handleGlobalKeys(event)">
    <div class="top-nav">
        <button class="btn-main" onclick="sendText()">+ Paste & Next</button>
        <div class="scale-section">
            <span class="scale-label">scale:</span>
            <input type="number" id="scaleInput" class="scale-input" value="100" oninput="saveData()">
            <span style="color:#ccc;">%</span>
        </div>
        <button onclick="openAddStyle()" style="background:#444; border:none; color:white; padding:8px; cursor:pointer; border-radius:2px;">➕</button>
        <button onclick="toggleModal('settingsModal')" style="background:#444; border:none; color:white; padding:8px; cursor:pointer; border-radius:2px;">⚙</button>
    </div>

    <textarea id="input" oninput="handleInput()" placeholder="Paste script manhwa di sini..."></textarea>
    
    <div class="main-content">
        <div class="list-box" id="list"></div>
        <div class="style-grid" id="styleGrid"></div>
    </div>

    <div id="styleModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <strong id="styleModalTitle">Style Settings</strong>
                <button onclick="toggleModal('styleModal')" style="color:#f44; border:none; background:none; cursor:pointer; font-weight:bold;">✕</button>
            </div>
            <input type="hidden" id="editStyleId">
            <label>Style Name</label>
            <input type="text" id="sName" class="modal-input">
            
            <label>Font Name (Copy persis dari Photopea)</label>
            <input type="text" id="sFont" class="modal-input" placeholder="Contoh: 2Dumb">
            
            <label>Appearance Style</label>
            <select id="sWeight" class="modal-select">
                <option value="Regular">Regular</option>
                <option value="Bold">Forced Bold</option>
                <option value="Italic">Forced Italic</option>
                <option value="Bold Italic">Forced Bold Italic</option>
            </select>

            <label>Base Size (px)</label>
            <input type="number" id="sSize" class="modal-input">
            <label>Prefixes (Pisahkan dengan koma)</label>
            <input type="text" id="sPrefix" class="modal-input">
            <button style="background:var(--accent); color:white; border:none; padding:10px; width:100%; cursor:pointer; font-weight:bold;" onclick="saveStyle()">Save Style</button>
            <button style="background:#f44; color:white; border:none; padding:10px; width:100%; cursor:pointer; font-weight:bold; margin-top:5px;" id="btnDelStyle" onclick="deleteStyle()">Delete Style</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <strong>Settings</strong>
                <button onclick="toggleModal('settingsModal')" style="color:#f44; border:none; background:none; cursor:pointer; font-weight:bold;">✕</button>
            </div>
            <label style="font-size:10px; color:#aaa; font-weight:bold;">Shortcut Info</label>
            <div style="background:#222; padding:8px; margin:5px 0 15px; border:1px solid #444;">
                <span>WIN + CTRL <small style="color:#ffca28; margin-left:5px;">(click line first)</small></span>
            </div>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <button onclick="exportJSON()" style="flex:1; padding:8px; background:#444; color:white; border:none; cursor:pointer;">Export JSON</button>
                <button onclick="document.getElementById('importFile').click()" style="flex:1; padding:8px; background:#444; color:white; border:none; cursor:pointer;">Import JSON</button>
            </div>
            <input type="file" id="importFile" style="display:none" onchange="importJSON(event)">
            <label style="font-size:10px; color:#aaa; font-weight:bold;">Tags to Ignore</label>
            <textarea id="ignoreTags" class="modal-input" style="height:100px;" oninput="saveSettings()"></textarea>
            <button onclick="if(confirm('Reset semua data?')){localStorage.clear(); location.reload();}" style="background:#f44; color:white; border:none; padding:5px; width:100%; cursor:pointer; font-size:9px; margin-top:10px;">RESET ALL DATA</button>
        </div>
    </div>

    <div class="footer">
        typer for photopea ( inspired by <a href="https://typer.hayasaku.fr" target="_blank">typer.hayasaku.fr</a> )
        <div style="font-size:9px; color:#888; margin-top:2px;">v3.7 | Font Fallback Prevention | Light Footer</div>
    </div>

    <script>
        let selectedIndex = -1;
        let activeStyleId = null;
        let filteredLines = [];
        let styles = [];
        const DEFAULT_TAGS = "SFX:\nSfx:\nsfx:\nSFX\nSfx\nsfx\n##\nHalaman\nPage\n---\npage\n===\nP1\nP2\n[1]\nPg.\nPAGE\n=0\n--";

        function handleGlobalKeys(e) {
            if (e.ctrlKey && (e.metaKey || e.key === "Meta" || e.code.includes("Meta"))) {
                e.preventDefault(); sendText();
            }
        }

        function toggleModal(id) {
            document.getElementById(id).style.display = (document.getElementById(id).style.display === 'block') ? 'none' : 'block';
        }

        function handleInput() { saveData(); renderLines(); }

        function saveData() {
            localStorage.setItem('typer_main_text', document.getElementById('input').value);
            localStorage.setItem('typer_scale', document.getElementById('scaleInput').value);
            localStorage.setItem('typer_styles', JSON.stringify(styles));
            localStorage.setItem('typer_active_style', activeStyleId);
            localStorage.setItem('ignoreTags', document.getElementById('ignoreTags').value);
        }

        function saveSettings() { saveData(); renderLines(); }

        function renderStyleGrid() {
            const grid = document.getElementById('styleGrid');
            grid.innerHTML = '';
            styles.forEach(s => {
                const item = document.createElement('div');
                item.className = `style-item ${activeStyleId == s.id ? 'active' : ''}`;
                item.onclick = () => { activeStyleId = s.id; renderStyleGrid(); saveData(); };
                item.innerHTML = `<div class="style-name">${s.name}</div><span class="edit-icon" onclick="event.stopPropagation(); openEditStyle('${s.id}')">✎</span>`;
                grid.appendChild(item);
            });
        }

        function openAddStyle() {
            document.getElementById('styleModalTitle').innerText = "Add New Style";
            document.getElementById('editStyleId').value = "";
            document.getElementById('sName').value = "";
            document.getElementById('sFont').value = "";
            document.getElementById('sWeight').value = "Regular";
            document.getElementById('sSize').value = 50;
            document.getElementById('sPrefix').value = "";
            document.getElementById('btnDelStyle').style.display = "none";
            toggleModal('styleModal');
        }

        function openEditStyle(id) {
            const s = styles.find(x => x.id == id);
            if(!s) return;
            document.getElementById('styleModalTitle').innerText = "Edit Style";
            document.getElementById('editStyleId').value = s.id;
            document.getElementById('sName').value = s.name;
            document.getElementById('sFont').value = s.font;
            document.getElementById('sWeight').value = s.weight || "Regular";
            document.getElementById('sSize').value = s.size;
            document.getElementById('sPrefix').value = (s.prefixes || []).join(", ");
            document.getElementById('btnDelStyle').style.display = "block";
            toggleModal('styleModal');
        }

        function saveStyle() {
            const id = document.getElementById('editStyleId').value;
            const newStyle = {
                id: id || Date.now().toString(),
                name: document.getElementById('sName').value || "Unnamed Style",
                font: document.getElementById('sFont').value || "Arial",
                weight: document.getElementById('sWeight').value,
                size: parseInt(document.getElementById('sSize').value) || 50,
                prefixes: document.getElementById('sPrefix').value.split(",").map(x => x.trim()).filter(x => x !== "")
            };
            if(id) {
                const idx = styles.findIndex(x => x.id == id);
                styles[idx] = newStyle;
            } else {
                styles.push(newStyle);
                if(!activeStyleId) activeStyleId = newStyle.id;
            }
            saveData(); renderStyleGrid(); renderLines(); toggleModal('styleModal');
        }

        function deleteStyle() {
            const id = document.getElementById('editStyleId').value;
            styles = styles.filter(x => x.id != id);
            if(activeStyleId == id) activeStyleId = styles[0]?.id || null;
            saveData(); renderStyleGrid(); renderLines(); toggleModal('styleModal');
        }

        function renderLines() {
            const val = document.getElementById('input').value;
            const ignoreList = (document.getElementById('ignoreTags').value || "").split('\n').map(t => t.trim()).filter(t => t !== "");
            const list = document.getElementById('list');
            list.innerHTML = ''; filteredLines = [];

            val.split('\n').forEach((line) => {
                if(!line.trim() || ignoreList.some(tag => line.trim().startsWith(tag))) return;
                let detectedPrefix = "";
                styles.forEach(s => { (s.prefixes || []).forEach(p => { if(line.trim().startsWith(p)) detectedPrefix = p; }); });
                filteredLines.push(line);
                let idx = filteredLines.length - 1;
                const row = document.createElement('div');
                row.className = `row ${selectedIndex === idx ? 'active' : ''}`;
                row.id = 'row-' + idx;
                row.innerHTML = `<span class="num">${idx + 1}</span><span style="flex:1;">${detectedPrefix ? `<span class="tag-pill">${detectedPrefix}</span>` : ""}${line.trim().replace(detectedPrefix, "").trim()}</span>`;
                row.onclick = () => selectRow(idx);
                list.appendChild(row);
            });
        }

        function selectRow(index) {
            if (index < 0 || index >= filteredLines.length) return;
            selectedIndex = index;
            const line = filteredLines[index].trim();
            styles.forEach(s => { if((s.prefixes || []).some(p => line.startsWith(p))) activeStyleId = s.id; });
            renderStyleGrid(); renderLines();
            document.getElementById('row-' + index)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            saveData();
        }

        function sendText() {
            if(selectedIndex === -1 || !filteredLines[selectedIndex]) return;
            const scale = (parseFloat(document.getElementById('scaleInput').value) || 100) / 100;
            const style = styles.find(s => s.id == activeStyleId) || { font: "Arial", size: 50, prefixes: [], weight: "Regular" };
            
            let raw = filteredLines[selectedIndex].trim();
            let prefix = (style.prefixes || []).find(p => raw.startsWith(p)) || "";
            let text = raw.replace(prefix, "").trim();

            let w = text.split(' '), s = "";
            for (let i = 0; i < w.length; i++) {
                s += w[i] + " "; if ((i + 1) % 3 === 0 && i !== w.length - 1) s += "\\r";
            }

            const ppea = `
                var doc = app.activeDocument;
                var sel; try { sel = doc.selection.bounds; } catch(e) { sel = null; }
                var layer = doc.artLayers.add();
                layer.kind = LayerKind.TEXT;
                var ti = layer.textItem;
                ti.contents = "${s.trim().replace(/"/g, '\\"')}";
                
                // Smart Font Finder: Mencari font yang paling mirip namanya
                var target = "${style.font}".toLowerCase().replace(/\\s/g, "");
                var foundFont = null;
                for(var i=0; i<app.fonts.length; i++) {
                    var f = app.fonts[i];
                    var fName = f.name.toLowerCase().replace(/\\s/g, "");
                    var pName = f.postScriptName.toLowerCase().replace(/\\s/g, "");
                    if(fName == target || pName == target) {
                        foundFont = f.postScriptName; break;
                    }
                }

                if(foundFont) { 
                    ti.font = foundFont; 
                } else {
                    // Jika tidak ketemu, coba paksa nama yang diinput user
                    try { ti.font = "${style.font}"; } catch(e) {}
                }
                
                ti.size = ${style.size * scale};
                ti.justification = Justification.CENTER;

                var weight = "${style.weight}";
                if(weight.indexOf("Bold") != -1) { try { ti.fauxBold = true; } catch(e) {} }
                if(weight.indexOf("Italic") != -1) { try { ti.fauxItalic = true; } catch(e) {} }

                if (sel) { ti.position = [(sel[0] + sel[2]) / 2, (sel[1] + sel[3]) / 2]; }
                else { ti.position = [doc.width / 2, doc.height / 2]; }
            `;
            window.parent.postMessage(ppea, "*");
            setTimeout(() => selectRow(selectedIndex + 1), 50); 
        }

        function exportJSON() {
            const data = { styles, ignoreTags: document.getElementById('ignoreTags').value };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = 'typer_styles.json'; a.click();
        }

        function importJSON(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.styles) {
                        styles = data.styles.map(s => ({
                            id: s.id || Math.random().toString(),
                            name: s.name,
                            font: s.font || s.textProps?.layerText?.textStyleRange[0]?.textStyle?.fontName || "Arial",
                            weight: s.weight || "Regular",
                            size: s.size || s.textProps?.layerText?.textStyleRange[0]?.textStyle?.size || 50,
                            prefixes: s.prefixes || []
                        }));
                    }
                    if (data.ignoreTags) document.getElementById('ignoreTags').value = data.ignoreTags;
                    saveData(); renderStyleGrid(); renderLines(); alert("Import Success!");
                } catch(err) { alert("Error importing JSON"); }
            };
            reader.readAsText(e.target.files[0]);
        }

        window.onload = () => {
            styles = JSON.parse(localStorage.getItem('typer_styles')) || [];
            activeStyleId = localStorage.getItem('typer_active_style');
            let savedTags = localStorage.getItem('ignoreTags');
            document.getElementById('ignoreTags').value = (savedTags === null) ? DEFAULT_TAGS : savedTags;
            document.getElementById('input').value = localStorage.getItem('typer_main_text') || "";
            document.getElementById('scaleInput').value = localStorage.getItem('typer_scale') || "100";
            renderStyleGrid(); renderLines();
        }
    </script>
</body>
</html>
