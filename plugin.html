<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        :root { 
            --bg-dark: #282828; --bg-darker: #1a1a1a; --accent: #0078d4;
            --text-light: #eee; --border-dark: #444; --row-hover: #333;
            --row-active: #094771; --footer-bg: #f5f5f5; --footer-text: #333;
        }
        body { background: var(--bg-dark); color: var(--text-light); font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; font-size: 11px; user-select: none; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header & Main Nav */
        .top-nav { display: flex; gap: 4px; padding: 5px; background: #333; border-bottom: 1px solid var(--border-dark); align-items: center; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 8px; flex: 1; cursor: pointer; font-weight: bold; border-radius: 2px; }
        
        .scale-section { display: flex; align-items: center; background: #444; border-radius: 2px; border: 1px solid #555; height: 28px; padding-right: 5px; }
        .scale-label { font-size: 10px; color: #ccc; padding: 0 8px; }
        .scale-input { background: transparent; border: none; color: white; width: 35px; text-align: center; font-weight: bold; outline: none; }

        textarea { width: 100%; height: 80px; background: var(--bg-darker); color: #fff; border: none; border-bottom: 1px solid var(--border-dark); padding: 8px; box-sizing: border-box; resize: none; font-family: 'Consolas', monospace; outline: none; }
        
        /* Style Bar */
        .style-bar { display: flex; gap: 5px; padding: 5px; background: #222; overflow-x: auto; border-bottom: 1px solid #444; }
        .style-btn { background: #444; color: #ccc; border: 1px solid #555; padding: 4px 10px; cursor: pointer; white-space: nowrap; border-radius: 2px; }
        .style-btn.active { background: var(--accent); color: white; border-color: #0089f2; }

        /* List Area */
        .list-box { flex: 1; overflow-y: auto; background: #222; }
        .row { display: flex; align-items: center; border-bottom: 1px solid #333; padding: 8px 12px; cursor: pointer; }
        .row.active { background: var(--row-active); border-left: 3px solid var(--accent); }
        .num { color: #666; width: 30px; font-size: 10px; }
        .tag-pill { background: #FFF3B0; color: #333; padding: 0 4px; border-radius: 2px; margin-right: 6px; font-weight: bold; font-size: 9px; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; padding: 15px; box-sizing: border-box; }
        .modal-content { background: #333; padding: 15px; border-radius: 4px; border: 1px solid #555; max-height: 95%; overflow-y: auto; color: #fff; }
        .modal-btn { background: #444; color: white; border: 1px solid #555; padding: 8px; cursor: pointer; margin-top: 10px; width: 100%; }
        .modal-input { background: #1a1a1a; color: #fff; border: 1px solid #555; padding: 8px; width: 100%; box-sizing: border-box; margin-top: 5px; border-radius: 2px; }

        /* Footer */
        .footer { background: var(--footer-bg); padding: 8px; font-size: 10px; color: var(--footer-text); border-top: 1px solid #ccc; text-align: center; font-weight: 500; }
        .footer a { color: var(--accent); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body onkeydown="handleGlobalKeys(event)">
    <div class="top-nav">
        <button class="btn-main" onclick="sendText()">+ Paste & Next</button>
        <div class="scale-section">
            <span class="scale-label">scale:</span>
            <input type="number" id="scaleInput" class="scale-input" value="100" oninput="saveData()">
            <span style="color:#ccc;">%</span>
        </div>
        <button onclick="toggleModal('styleModal')" style="background:#444; border:none; color:white; padding:8px; cursor:pointer;">ðŸŽ¨</button>
        <button onclick="toggleModal('settingsModal')" style="background:#444; border:none; color:white; padding:8px; cursor:pointer;">âš™</button>
    </div>

    <div class="style-bar" id="styleBar"></div>

    <textarea id="input" oninput="handleInput()" placeholder="Paste script manhwa di sini..."></textarea>
    <div class="list-box" id="list"></div>

    <div id="styleModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <strong>Style Management</strong>
                <button onclick="toggleModal('styleModal')" style="color:#f44; border:none; background:none; cursor:pointer;">âœ•</button>
            </div>
            <button class="modal-btn" style="background:var(--accent)" onclick="addNewStyle()">+ Add New Style</button>
            <div id="styleListEditor" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <strong>Settings & Backup</strong>
                <button onclick="toggleModal('settingsModal')" style="color:#f44; border:none; background:none; cursor:pointer;">âœ•</button>
            </div>
            <label style="font-size:10px; color:#aaa;">Import/Export JSON</label>
            <button class="modal-btn" onclick="exportJSON()">ðŸ“¤ Export Styles (JSON)</button>
            <button class="modal-btn" onclick="document.getElementById('importFile').click()">ðŸ“¥ Import Styles (JSON)</button>
            <input type="file" id="importFile" style="display:none" onchange="importJSON(event)">
            
            <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
            <label style="font-size:10px; color:#aaa;">Tags to Ignore</label>
            <textarea id="ignoreTags" class="modal-input" style="height:100px;" oninput="saveSettings()"></textarea>
        </div>
    </div>

    <div class="footer">
        typer for photopea ( inspired by <a href="https://typer.hayasaku.fr" target="_blank">typer.hayasaku.fr</a> )
        <div style="font-size:9px; color:#888; margin-top:2px;">v3.0 | Style & JSON System | Light Footer</div>
    </div>

    <script>
        let selectedIndex = -1;
        let activeStyleId = null;
        let filteredLines = [];
        let styles = [];
        const DEFAULT_TAGS = "SFX:\nSfx:\nsfx:\nSFX\nSfx\nsfx\n##\nHalaman\nPage\n---\npage\n===\nP1\nP2\n[1]\nPg.\nPAGE\n=0\n--";

        // Initial default style if empty
        const defaultStyleTemplate = {
            id: Date.now(),
            name: "Normal Speech",
            font: "CCVictorySpeech-Regular",
            size: 50,
            color: "#000000",
            prefixes: ["\"\":", "â€œâ€:"]
        };

        function handleGlobalKeys(e) {
            if (e.ctrlKey && (e.metaKey || e.key === "Meta" || e.code.includes("Meta"))) {
                e.preventDefault(); sendText();
            }
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.style.display = (m.style.display === 'block') ? 'none' : 'block';
            if(id === 'styleModal') renderStyleEditor();
        }

        function handleInput() { saveData(); renderLines(); }

        function saveData() {
            localStorage.setItem('typer_main_text', document.getElementById('input').value);
            localStorage.setItem('typer_scale', document.getElementById('scaleInput').value);
            localStorage.setItem('typer_styles', JSON.stringify(styles));
            localStorage.setItem('typer_active_style', activeStyleId);
        }

        function saveSettings() {
            localStorage.setItem('ignoreTags', document.getElementById('ignoreTags').value);
            renderLines();
        }

        function renderStyleBar() {
            const bar = document.getElementById('styleBar');
            bar.innerHTML = '';
            styles.forEach(s => {
                const btn = document.createElement('button');
                btn.className = `style-btn ${activeStyleId == s.id ? 'active' : ''}`;
                btn.innerText = s.name;
                btn.onclick = () => { activeStyleId = s.id; renderStyleBar(); saveData(); };
                bar.appendChild(btn);
            });
        }

        function renderLines() {
            const val = document.getElementById('input').value;
            const ignoreList = (document.getElementById('ignoreTags').value || "").split('\n').map(t => t.trim()).filter(t => t !== "");
            const rawLines = val.split('\n');
            const list = document.getElementById('list');
            list.innerHTML = ''; filteredLines = [];

            rawLines.forEach((line) => {
                if(!line.trim()) return;
                if(ignoreList.some(tag => line.trim().startsWith(tag))) return;

                // Auto Style Detect
                let detectedPrefix = "";
                styles.forEach(s => {
                    s.prefixes.forEach(p => { if(line.trim().startsWith(p)) detectedPrefix = p; });
                });

                filteredLines.push(line);
                let idx = filteredLines.length - 1;
                const row = document.createElement('div');
                row.className = `row ${selectedIndex === idx ? 'active' : ''}`;
                row.id = 'row-' + idx;
                
                const prefixHtml = detectedPrefix ? `<span class="tag-pill">${detectedPrefix}</span>` : "";
                const cleanTxt = detectedPrefix ? line.trim().replace(detectedPrefix, "").trim() : line.trim();

                row.innerHTML = `<span class="num">${idx + 1}</span><span style="flex:1;">${prefixHtml}${cleanTxt}</span>`;
                row.onclick = () => selectRow(idx);
                list.appendChild(row);
            });
        }

        function selectRow(index) {
            if (index < 0 || index >= filteredLines.length) return;
            selectedIndex = index;
            renderLines();
            document.getElementById('row-' + index)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto switch style based on prefix
            const line = filteredLines[index].trim();
            styles.forEach(s => {
                if(s.prefixes.some(p => line.startsWith(p))) activeStyleId = s.id;
            });
            renderStyleBar();
            saveData();
        }

        function sendText() {
            if(selectedIndex === -1 || !filteredLines[selectedIndex]) return;
            const scale = (parseFloat(document.getElementById('scaleInput').value) || 100) / 100;
            const currentStyle = styles.find(s => s.id == activeStyleId) || defaultStyleTemplate;
            
            let rawLine = filteredLines[selectedIndex].trim();
            let prefixFound = currentStyle.prefixes.find(p => rawLine.startsWith(p)) || "";
            let text = rawLine.replace(prefixFound, "").trim();

            // Auto-Shaping
            let w = text.split(' '), s = "";
            for (let i = 0; i < w.length; i++) {
                s += w[i] + " ";
                if ((i + 1) % 3 === 0 && i !== w.length - 1) s += "\\r";
            }

            const ppea = `
                var doc = app.activeDocument;
                var sel; try { sel = doc.selection.bounds; } catch(e) { sel = null; }
                var layer = doc.artLayers.add();
                layer.kind = LayerKind.TEXT;
                var ti = layer.textItem;
                ti.contents = "${s.trim().replace(/"/g, '\\"')}";
                ti.font = "${currentStyle.font}";
                ti.size = ${currentStyle.size * scale};
                ti.justification = Justification.CENTER;
                if (sel) { ti.position = [(sel[0] + sel[2]) / 2, (sel[1] + sel[3]) / 2]; }
                else { ti.position = [doc.width / 2, doc.height / 2]; }
            `;
            window.parent.postMessage(ppea, "*");
            setTimeout(() => selectRow(selectedIndex + 1), 50); 
        }

        // Import/Export Logic
        function exportJSON() {
            const data = { version: "3.0", styles: styles, ignoreTags: document.getElementById('ignoreTags').value };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'typer_styles_backup.json'; a.click();
        }

        function importJSON(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if(data.styles) {
                        styles = data.styles;
                        if(data.ignoreTags) document.getElementById('ignoreTags').value = data.ignoreTags;
                        saveData(); renderStyleBar(); renderLines();
                        alert("Styles imported successfully!");
                    }
                } catch(err) { alert("Invalid JSON file"); }
            };
            reader.readAsText(file);
        }

        window.onload = () => {
            styles = JSON.parse(localStorage.getItem('typer_styles')) || [defaultStyleTemplate];
            activeStyleId = localStorage.getItem('typer_active_style') || styles[0].id;
            
            let savedTags = localStorage.getItem('ignoreTags');
            document.getElementById('ignoreTags').value = (savedTags === null) ? DEFAULT_TAGS : savedTags;
            
            let savedText = localStorage.getItem('typer_main_text');
            if (savedText !== null) document.getElementById('input').value = savedText;
            
            let savedScale = localStorage.getItem('typer_scale');
            if (savedScale !== null) document.getElementById('scaleInput').value = savedScale;

            renderStyleBar(); renderLines();
        }
    </script>
</body>
</html>
