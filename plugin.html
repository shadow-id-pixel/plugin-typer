<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        :root { 
            --bg-dark: #282828; --bg-darker: #1a1a1a; --accent: #0078d4;
            --text-light: #eee; --border-dark: #444; --row-hover: #333;
            --row-active: #094771;
        }
        body { background: var(--bg-dark); color: var(--text-light); font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; font-size: 11px; user-select: none; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .top-nav { display: flex; gap: 4px; padding: 5px; background: #333; border-bottom: 1px solid var(--border-dark); align-items: center; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 8px; flex: 1; cursor: pointer; font-weight: bold; border-radius: 2px; }
        
        .scale-section { display: flex; align-items: center; background: #444; border-radius: 2px; border: 1px solid #555; height: 28px; }
        .scale-label { font-size: 10px; color: #ccc; padding: 0 8px; }
        .scale-input { background: transparent; border: none; color: white; width: 35px; text-align: center; font-weight: bold; outline: none; }
        
        .size-btn { background: #555; border: none; color: white; width: 28px; height: 100%; cursor: pointer; font-size: 16px; border-left: 1px solid #666; display: flex; justify-content: center; align-items: center; }
        .size-btn:hover { background: #666; }

        textarea { width: 100%; height: 80px; background: var(--bg-darker); color: #fff; border: none; border-bottom: 1px solid var(--border-dark); padding: 8px; box-sizing: border-box; resize: none; font-family: 'Consolas', monospace; outline: none; }
        .list-box { flex: 1; overflow-y: auto; background: #222; }
        .row { display: flex; align-items: center; border-bottom: 1px solid #333; padding: 8px 12px; cursor: pointer; }
        .row.active { background: var(--row-active); border-left: 3px solid var(--accent); }
        .tag { color: #ffca28; margin-right: 8px; font-weight: bold; }

        #settingsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; padding: 15px; box-sizing: border-box; }
        .modal-content { background: #333; padding: 15px; border-radius: 4px; border: 1px solid #555; max-height: 95%; overflow-y: auto; color: #fff; }
        .modal-input { background: #1a1a1a; color: #fff; border: 1px solid #555; padding: 8px; width: 100%; box-sizing: border-box; margin-top: 5px; border-radius: 2px; }

        .footer { background: #1a1a1a; padding: 8px; font-size: 10px; color: #666; border-top: 1px solid var(--border-dark); text-align: center; }
    </style>
</head>
<body onkeydown="handleGlobalKeys(event)">
    <div class="top-nav">
        <button class="btn-main" onclick="sendText()">+ Paste & Next</button>
        <div class="scale-section">
            <span class="scale-label">font size:</span>
            <input type="number" id="scaleInput" class="scale-input" value="100">
            <span style="color:#ccc; padding-right:8px;">%</span>
            <button class="size-btn" onclick="adjustScale(0.9)" title="Decrease Size (*)">*</button>
            <button class="size-btn" onclick="adjustScale(1.1)" title="Increase Size (+)">+</button>
        </div>
        <button onclick="toggleSettings()" style="background:#444; border:none; color:white; padding:8px 12px; cursor:pointer; border-radius:2px;">⚙</button>
    </div>

    <textarea id="input" oninput="renderLines()" placeholder="Paste script manhwa di sini..."></textarea>
    <div class="list-box" id="list"></div>

    <div id="settingsModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <strong>Settings</strong>
                <button onclick="toggleSettings()" style="color:#f44; border:none; background:none; cursor:pointer;">✕ Close</button>
            </div>
            <label style="font-size:10px; color:#aaa;">Tags for ignoring the lines</label>
            <textarea id="ignoreTags" class="modal-input" style="height:150px;" oninput="saveSettings()"></textarea>
        </div>
    </div>

    <div class="footer">
        typer for photopea | v2.1 | Shortcut: + (bigger), * (smaller)
    </div>

    <script>
        let selectedIndex = -1;
        let filteredLines = [];
        const DEFAULT_TAGS = "SFX:\nSfx:\nsfx:\nSFX\nSfx\nsfx\n##\nHalaman\nPage\n---\npage\n===\nP1\nP2\n[1]\nPg.\nPAGE\n=0\n--";

        function adjustScale(factor) {
            const input = document.getElementById('scaleInput');
            input.value = Math.round((parseFloat(input.value) || 100) * factor);
        }

        function handleGlobalKeys(e) {
            // Numpad Plus (+) untuk memperbesar font di plugin
            if (e.key === "+") { 
                e.preventDefault(); 
                adjustScale(1.1); 
            }
            // Numpad Asterisk (*) untuk memperkecil font di plugin
            if (e.key === "*") { 
                e.preventDefault(); 
                adjustScale(0.9); 
            }
            // Ctrl + Enter untuk navigasi baris
            if (e.ctrlKey && e.key === "Enter") { 
                e.preventDefault(); 
                selectRow(selectedIndex + 1); 
            }
        }

        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }

        function saveSettings() {
            localStorage.setItem('ignoreTags', document.getElementById('ignoreTags').value);
            renderLines();
        }

        function renderLines() {
            const val = document.getElementById('input').value;
            const ignoreList = (document.getElementById('ignoreTags').value || "").split('\n').map(t => t.trim()).filter(t => t !== "");
            const rawLines = val.split('\n');
            const list = document.getElementById('list');
            list.innerHTML = '';
            filteredLines = [];

            rawLines.forEach((line) => {
                if(!line.trim()) return;
                if(ignoreList.some(tag => line.trim().startsWith(tag))) return;

                filteredLines.push(line);
                let idx = filteredLines.length - 1;
                let div = document.createElement('div');
                div.className = 'row';
                div.id = 'row-' + idx;
                
                let match = line.match(/^([A-Z()]+):(.*)/);
                let tag = match ? match[1] + ":" : "";
                let txt = match ? match[2] : line;

                div.innerHTML = `<span style="color:#666; width:30px;">${idx + 1}</span><span style="flex:1;"><span class="tag">${tag}</span>${txt}</span>`;
                div.onclick = () => selectRow(idx);
                list.appendChild(div);
            });
        }

        function selectRow(index) {
            if (index < 0 || index >= filteredLines.length) return;
            selectedIndex = index;
            document.querySelectorAll('.row').forEach(r => r.classList.remove('active'));
            const activeRow = document.getElementById('row-' + index);
            if (activeRow) {
                activeRow.classList.add('active');
                activeRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function sendText() {
            if(selectedIndex === -1 || !filteredLines[selectedIndex]) return;
            const scale = (parseFloat(document.getElementById('scaleInput').value) || 100) / 100;
            let line = filteredLines[selectedIndex];
            let match = line.match(/^([A-Z()]+):(.*)/);
            let text = match ? match[2].trim() : line.trim();

            let w = text.split(' '), s = "";
            for (let i = 0; i < w.length; i++) {
                s += w[i] + " ";
                if ((i + 1) % 3 === 0 && i !== w.length - 1) s += "\\r";
            }

            const ppea = `
                var doc = app.activeDocument;
                var sel; try { sel = doc.selection.bounds; } catch(e) { sel = null; }
                var layer = doc.artLayers.add();
                layer.kind = LayerKind.TEXT;
                var ti = layer.textItem;
                ti.contents = "${s.trim().replace(/"/g, '\\"')}";
                ti.size = ${25 * scale};
                ti.justification = Justification.CENTER;
                if (sel) { ti.position = [(sel[0] + sel[2]) / 2, (sel[1] + sel[3]) / 2]; }
                else { ti.position = [doc.width / 2, doc.height / 2]; }
            `;
            window.parent.postMessage(ppea, "*");
            selectRow(selectedIndex + 1);
        }

        window.onload = () => {
            let saved = localStorage.getItem('ignoreTags');
            document.getElementById('ignoreTags').value = (saved === null) ? DEFAULT_TAGS : saved;
            renderLines();
        }
    </script>
</body>
</html>
